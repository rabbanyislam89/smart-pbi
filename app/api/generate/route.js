import { GoogleGenerativeAI } from "@google/generative-ai";
import { NextResponse } from "next/server";

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

export async function POST(req) {
  try {
    const data = await req.formData();
    const file = data.get("file");
    const note = data.get("note") || "";

    if (!file) {
      return NextResponse.json({ error: "No file uploaded" }, { status: 400 });
    }

    const bytes = await file.arrayBuffer();
    const buffer = Buffer.from(bytes);
    const base64Data = buffer.toString("base64");

    const model = genAI.getGenerativeModel({ model: "gemini-flash-latest" });

    // ==================================================================================
    // ЁЯФе ржлрж┐ржХрзНрж╕: ржЕрждрж┐рж░рж┐ржХрзНржд <p>&nbsp;</p> ржмрж╛ <br> ржлрзЗрж▓рзЗ ржжрзЗржУрзЯрж╛ рж╣рзЯрзЗржЫрзЗред
    // ржПржЦржи ржкрзНржпрж╛рж░рж╛ржЧрзНрж░рж╛ржлрзЗрж░ ржорж╛ржЭрзЗ ржирзНржпрж╛ржЪрж╛рж░рж╛рж▓ ржЧрзНржпрж╛ржк ржерж╛ржХржмрзЗред
    // ==================================================================================
    
    const prompt = `
      ржнрзВржорж┐ржХрж╛: рждрзБржорж┐ ржПржХржЬржи ржкрж┐ржмрж┐ржЖржЗ рждржжржирзНржд ржХрж░рзНржоржХрж░рзНрждрж╛ред ржкрж┐ржбрж┐ржПржлржЯрж┐ ржкрзЬрзЛред

      ржХрж╛ржЬ: ржирж┐ржЪрзЗрж░ рждржерзНржпржЧрзБрж▓рзЛ ржмрзЗрж░ ржХрж░рзЗ ржПржХржЯрж┐ HTML рж░рж┐ржкрзЛрж░рзНржЯ рждрзИрж░рж┐ ржХрж░рзЛред

      рж╕рждрж░рзНржХрждрж╛:
      рзз. ржЖржЙржЯржкрзБржЯ рж╢рзБржзрзБржорж╛рждрзНрж░ HTML ржХрзЛржб рж╣ржмрзЗред
      рзи. <div> ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗ ржирж╛ред ржкрзНрж░рждрж┐ржЯрж┐ рж▓рж╛ржЗржирзЗрж░ ржЬржирзНржп <p> ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗред
      рзй. **ржкрзНржпрж╛рж░рж╛ржЧрзНрж░рж╛ржлрзЗрж░ ржорж╛ржЭрзЗ ржХрзЛржирзЛ ржмрж╛рзЬрждрж┐ <br> ржмрж╛ ржлрж╛ржБржХрж╛ рж▓рж╛ржЗржи ржжрж┐ржмрзЗ ржирж╛ред**

      ржЖржЙржЯржкрзБржЯ рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ (рж╣рзБржмрж╣рзБ ржПржЗ ржлрж░ржорзНржпрж╛ржЯрзЗ ржжрж┐ржмрзЗ):

      <p><b>ржмрж░рж╛ржмрж░</b></p>
      <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ржЖржжрж╛рж▓рждрзЗрж░ ржирж╛ржо]</p>
      <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ржЖржжрж╛рж▓рждрзЗрж░ рж╕рзНржерж╛ржи/ржЬрзЗрж▓рж╛]</p>
      
      <p><b>ржорж╛ржзрзНржпржо : ржпржерж╛ржпрже ржХрж░рзНрждрзГржкржХрзНрж╖ред</b></p>
      
      <p><b>ржмрж┐рж╖рзЯ : ржЕржирзБрж╕ржирзНржзрж╛ржи/рждржжржирзНржд ржкрзНрж░рждрж┐ржмрзЗржжржи ржкрзНрж░рзЗрж░ржг ржкрзНрж░рж╕ржЩрзНржЧрзЗред</b></p>
      
      <p><b>рж╕рзВрждрзНрж░ :</b> [ржорж╛ржорж▓рж╛ ржиржВ, рждрж╛рж░рж┐ржЦ ржУ ржзрж╛рж░рж╛]</p>

      <p>ржЬржирж╛ржм,</p>
      <p>ржмрж┐ржирзАржд ржирж┐ржмрзЗржжржи ржПржЗ ржпрзЗ, рж╕рзВрждрзНрж░рзЛржХрзНржд ржорж╛ржорж▓рж╛ржЯрж┐ рждржжржирзНрждрзЗрж░ ржЬржирзНржп ржкрж┐ржмрж┐ржЖржЗ-ржХрзЗ ржирж┐рж░рзНржжрзЗрж╢ ржкрзНрж░ржжрж╛ржи ржХрж░рж▓рзЗ ржЖржорж┐ ржПрж░ рждржжржирзНрждржнрж╛рж░ ржЧрзНрж░рж╣ржг ржХрж░рж┐ред ржЖржорж╛рж░ ржкрзНрж░ржХрж╛рж╢рзНржп ржУ ржЧрзЛржкржи рждржжржирзНрждрзЗ ржкрзНрж░рж╛ржкрзНржд рждржерзНржпрзЗрж░ ржЖрж▓рзЛржХрзЗ ржирж┐ржорзНржирзЛржХрзНржд ржкрзНрж░рждрж┐ржмрзЗржжржи ржжрж╛ржЦрж┐рж▓ ржХрж░рж▓рж╛ржоред</p>

      <p><b>рззред ржмрж╛ржжрзА/ржЕржнрж┐ржпрзЛржЧржХрж╛рж░рзАрж░ ржирж╛ржо ржУ ржарж┐ржХрж╛ржирж╛:</b> [рждржерзНржп]</p>

      <p><b>рзиред ржмрж┐ржмрж╛ржжрзА/ржмрж┐ржмрж╛ржжрзАржжрзЗрж░ ржирж╛ржо ржУ ржарж┐ржХрж╛ржирж╛:</b></p>
      <p>&nbsp;&nbsp;&nbsp;&nbsp;рззред [ржирж╛ржо ржУ ржарж┐ржХрж╛ржирж╛]</p>
      <p>&nbsp;&nbsp;&nbsp;&nbsp;рзиред [ржирж╛ржо ржУ ржарж┐ржХрж╛ржирж╛]</p>

      <p><b>рзйред ржШржЯржирж╛рж╕рзНржерж▓, ржШржЯржирж╛рж░ рждрж╛рж░рж┐ржЦ ржУ рж╕ржорзЯржХрж╛рж▓ (ржЪрзМрж╣ржжрзНржжрзА рж╕рж╣):</b> [рждржерзНржп]</p>

      <p><b>рзкред рждржжрж╛рж░ржХрзА ржЕржлрж┐рж╕рж╛рж░:</b> [ржирж╛ржо ржУ ржкржжржмрзА]</p>

      <p><b>рзлред ржирж╛рж▓рж┐рж╢рзА ржжрж░ржЦрж╛рж╕рзНрждрзЗрж░ рж╕рж╛рж░рж╛ржВрж╢:</b></p>
      <p>[ржмрж┐ржмрж░ржг]</p>

      <p><b>рзмред ржмрж┐ржЬрзНржЮ ржЖржжрж╛рж▓рждрзЗрж░ ржЖржжрзЗрж╢ ржкрж░рзНржпрж╛рж▓рзЛржЪржирж╛:</b></p>
      <p>[ржмрж┐ржмрж░ржг]</p>

      <p><b>рзнред ржЕржнрж┐ржпрзЛржЧ ржкрж░рзНржпрж╛рж▓рзЛржЪржирж╛рзЯ ржмрж┐ржмрзЗржЪрзНржп ржмрж┐рж╖рзЯ рж╕ржорзВрж╣:</b></p>
      <p>[ржкрзЯрзЗржирзНржЯ]</p>

      <p><b>рзоред ржкрж┐ржмрж┐ржЖржЗ ржХрж░рзНрждрзГржХ ржорж╛ржорж▓рж╛ ржЧрзНрж░рж╣ржгрзЗрж░ рждрж╛рж░рж┐ржЦ:</b> [рждрж╛рж░рж┐ржЦ]</p>

      <p><b>рзпред ржШржЯржирж╛рж╕рзНржерж▓ ржкрж░рж┐ржжрж░рзНрж╢ржи ржУ ржорзНржпрж╛ржк:</b></p>
      <p>[ржмрж┐ржмрж░ржг]</p>

      <p><b>рззрзжред ржЕржнрж┐ржпрзЛржЧржХрж╛рж░рзАржХрзЗ ржЬрж┐ржЬрзНржЮрж╛рж╕рж╛ржмрж╛ржж:</b></p>
      <p>[ржмрж┐ржмрж░ржг]</p>

      <p><b>рззрззред рж╕рж╛ржХрзНрж╖рзАржжрзЗрж░ ржирж╛ржо ржУ ржарж┐ржХрж╛ржирж╛:</b></p>
      <p>&nbsp;&nbsp;&nbsp;&nbsp;рззред [ржирж╛ржо ржУ ржарж┐ржХрж╛ржирж╛]</p>
      <p>&nbsp;&nbsp;&nbsp;&nbsp;рзиред [ржирж╛ржо ржУ ржарж┐ржХрж╛ржирж╛]</p>

      <p><b>рззрзиред ржЖрж▓рж╛ржоржд ржЬржмрзНржж:</b> [ржмрж┐ржмрж░ржг]</p>

      <p><b>рззрзйред ржмрж┐рж╢рзЗрж╖ржЬрзНржЮрзЗрж░ ржорждрж╛ржоржд (ржЬржЦржорж┐ рж╕ржиржж):</b> [ржмрж┐ржмрж░ржг]</p>

      <p><b>рззрзкред ржжрж╛рж▓рж┐рж▓рж┐ржХ рж╕рж╛ржХрзНрж╖рзНржпрзЗрж░ ржкрж░рзНржпрж╛рж▓рзЛржЪржирж╛:</b></p>
      <p>[ржмрж┐ржмрж░ржг]</p>

      <p><b>рззрзлред ржкрж┐ржмрж┐ржЖржЗ ржХрж░рзНрждрзГржХ рждржжржирзНржд/ржЕржирзБрж╕ржирзНржзрж╛ржи (ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд):</b></p>
      <p>[рж╕рж░ржЬржорж┐ржи рждржжржирзНрждрзЗрж░ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржмрж░рзНржгржирж╛]</p>

      <p><b>рззрзмред ржорждрж╛ржоржд:</b></p>
      <p>[ржЪрзВрзЬрж╛ржирзНржд ржорждрж╛ржоржд]</p>

      ржЕржлрж┐рж╕рж╛рж░рзЗрж░ ржирзЛржЯ: "${note}"

      ржмрж┐рж╢рзЗрж╖ ржирж┐рж░рзНржжрзЗрж╢:
      - ржпржжрж┐ ржЖржжрж╛рж▓рждрзЗрж░ ржирж╛ржо ржкрж┐ржбрж┐ржПржлрзЗ ржирж╛ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯ, рждржмрзЗ рж▓рж┐ржЦржмрзЗ: "ржЖржкржирж╛рж░ ржкрж┐ржбрж┐ржПржл ржП ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ ржирж╛ржЗ ржЖржжрж╛рж▓рждрзЗрж░ рждржерзНржп"ред
    `;

    const result = await model.generateContent([
      prompt,
      {
        inlineData: {
          data: base64Data,
          mimeType: file.type || "application/pdf",
        },
      },
    ]);

    let reportText = result.response.text();
    reportText = reportText.replace(/```html/g, "").replace(/```/g, "");

    return NextResponse.json({ report: reportText });

  } catch (error) {
    console.error("Error:", error);
    return NextResponse.json({ error: "рж╕рж╛рж░рзНржнрж╛рж░рзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗред" }, { status: 500 });
  }
}