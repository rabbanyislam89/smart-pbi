import { GoogleGenerativeAI } from "@google/generative-ai";
import { NextResponse } from "next/server";

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

export async function POST(req) {
  try {
    const { report } = await req.json();

    if (!report) {
      return NextResponse.json({ error: "Report content is missing" }, { status: 400 });
    }

    const model = genAI.getGenerativeModel({ model: "gemini-flash-latest" });

    // ==================================================================================
    // ЁЯФе рззрзмрзз ржЬржмрж╛ржиржмржирзНржжрж┐ ржЬрзЗржирж╛рж░рзЗржЯрж░ (Consistency + Page Break + Word Friendly)
    // рзз. рж░рж┐ржкрзЛрж░рзНржЯрзЗрж░ рждржерзНржпрзЗрж░ рж╕рж╛ржерзЗ рззрзжрзж% ржорж┐рж▓ рж░рж╛ржЦржмрзЗред
    // рзи. page-break-after ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ ржЖрж▓рж╛ржжрж╛ ржкрзЗржЬрзЗрж░ ржЬржирзНржпред
    // рзй. <p> ржЯрзНржпрж╛ржЧ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ ржпрж╛рждрзЗ рж▓рзЗржЦрж╛ ржПржХржЯрж╛рж░ ржЧрж╛рзЯрзЗ ржПржХржЯрж╛ ржирж╛ рж▓рж╛ржЧрзЗред
    // ==================================================================================

    const prompt = `
      ржнрзВржорж┐ржХрж╛: рждрзБржорж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ ржкрж┐ржмрж┐ржЖржЗ рждржжржирзНржд ржХрж░рзНржоржХрж░рзНрждрж╛ред ржирж┐ржЪрзЗ ржПржХржЯрж┐ рждржжржирзНржд ржкрзНрж░рждрж┐ржмрзЗржжржи (Report) ржжрзЗржУрзЯрж╛ рж╣рж▓рзЛред рждрзЛржорж╛рж░ ржХрж╛ржЬ рж╣рж▓рзЛ ржПржЗ рж░рж┐ржкрзЛрж░рзНржЯрзЗрж░ рждржерзНржпрзЗрж░ ржнрж┐рждрзНрждрж┐рждрзЗ ржлрзМржЬржжрж╛рж░рзА ржХрж╛рж░рзНржпржмрж┐ржзрж┐рж░ рззрзмрзз ржзрж╛рж░рж╛рзЯ рж╕рж╛ржХрзНрж╖рзАржжрзЗрж░ ржЬржмрж╛ржиржмржирзНржжрж┐ рждрзИрж░рж┐ ржХрж░рж╛ред

      ржЗржиржкрзБржЯ рж░рж┐ржкрзЛрж░рзНржЯ:
      """
      ${report}
      """

      ржХржарзЛрж░ ржирж┐рж░рзНржжрзЗрж╢рж╛ржмрж▓рзА (ржЖржжрж╛рж▓рждрзЗрж░ ржЬржирзНржп):
      рзз. **рж╕рждрзНржпрждрж╛ ржУ ржорж┐рж▓:** ржЬржмрж╛ржиржмржирзНржжрж┐рж░ рждржерзНржп ржЕржмрж╢рзНржпржЗ ржЙржкрж░рзЗрж░ рж░рж┐ржкрзЛрж░рзНржЯрзЗрж░ рждржерзНржпрзЗрж░ рж╕рж╛ржерзЗ рж╣рзБржмрж╣рзБ ржорж┐рж▓рждрзЗ рж╣ржмрзЗред ржШржЯржирж╛рж░ рждрж╛рж░рж┐ржЦ, рж╕ржорзЯ, ржЯрж╛ржХрж╛рж░ ржкрж░рж┐ржорж╛ржг, ржШржЯржирж╛рж╕рзНржерж▓ ржПржмржВ ржЖрж╕рж╛ржорзАрж░ ржирж╛ржо ржпрзЗржи рж░рж┐ржкрзЛрж░рзНржЯрзЗрж░ рж╕рж╛ржерзЗ рзз ржЪрзБрж▓ржУ ржнрж┐ржирзНржи ржирж╛ рж╣рзЯред
      рзи. **ржлрж░ржорзНржпрж╛ржЯ:** MS Word-ржП ржХржкрж┐ ржХрж░рж╛рж░ ржЬржирзНржп рж╢рзБржзрзБржорж╛рждрзНрж░ HTML <p> ржЯрзНржпрж╛ржЧ ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗред ржХрзЛржирзЛ <div> ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗ ржирж╛ред
      рзй. **ржкрзЗржЬ ржмрзНрж░рзЗржХ:** ржкрзНрж░рждрж┐ржЯрж┐ рж╕рж╛ржХрзНрж╖рзАрж░ ржЬржмрж╛ржиржмржирзНржжрж┐ рж╢рзЗрж╖ рж╣ржУрзЯрж╛рж░ ржкрж░ <br style="page-break-after: always;"> ржЯрзНржпрж╛ржЧ ржжрж┐ржмрзЗред
      рзк. **ржлрж╛ржБржХрж╛ ржЬрж╛рзЯржЧрж╛:** ржкрзНржпрж╛рж░рж╛ржЧрзНрж░рж╛ржлрзЗрж░ ржорж╛ржЭрзЗ ржлрж╛ржБржХрж╛ ржЬрж╛рзЯржЧрж╛рж░ ржЬржирзНржп <p>&nbsp;</p> ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗред

      ржЖржЙржЯржкрзБржЯ рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ (ржкрзНрж░рждрж┐ржЯрж┐ рж╕рж╛ржХрзНрж╖рзАрж░ ржЬржирзНржп рж╣рзБржмрж╣рзБ ржПржЗ ржлрж░ржорзНржпрж╛ржЯ):

      <p><b>рззрзмрзз ржзрж╛рж░рж╛рзЯ ржЬржмрж╛ржиржмржирзНржжрж┐ - рж╕рж╛ржХрзНрж╖рзА ржиржВ рзз</b></p>
      <p>&nbsp;</p>

      <p><b>ржирж╛ржо:</b> [рж░рж┐ржкрзЛрж░рзНржЯ ржерзЗржХрзЗ ржирж╛ржо]</p>
      <p><b>ржкрж┐рждрж╛/рж╕рзНржмрж╛ржорзА:</b> [рж░рж┐ржкрзЛрж░рзНржЯ ржерзЗржХрзЗ]</p>
      <p><b>рж╕рж╛ржВ:</b> [рж░рж┐ржкрзЛрж░рзНржЯ ржерзЗржХрзЗ]</p>
      <p><b>ржкрзЗрж╢рж╛:</b> [ржкрзЗрж╢рж╛]</p>
      <p>&nbsp;</p>

      <p><b>ржЬржмрж╛ржиржмржирзНржжрж┐:</b></p>
      <p>
        "ржЖржорж┐ ржЕрждрзНрж░ ржорж╛ржорж▓рж╛рж░ ржШржЯржирж╛рж░ ржмрж┐рж╖рзЯрзЗ ржЕржмржЧржд ржЖржЫрж┐ред ржЧржд [рж░рж┐ржкрзЛрж░рзНржЯрзЗ ржЙрж▓рзНрж▓рж┐ржЦрж┐ржд ржШржЯржирж╛рж░ рждрж╛рж░рж┐ржЦ] рждрж╛рж░рж┐ржЦрзЗ [ржШржЯржирж╛рж╕рзНржерж▓]-ржП ржШржЯржирж╛ржЯрж┐ ржШржЯрзЗред ржЖржорж┐ ржЬрж╛ржирж┐ ржпрзЗ, [рж░рж┐ржкрзЛрж░рзНржЯрзЗрж░ рждржерзНржпрзЗрж░ ржнрж┐рждрзНрждрж┐рждрзЗ ржШржЯржирж╛рж░ рж╕ржВржХрзНрж╖рж┐ржкрзНржд ржмрж░рзНржгржирж╛ ржпрж╛ рж░рж┐ржкрзЛрж░рзНржЯрзЗрж░ рж╕рж╛ржерзЗ ржорж┐рж▓рзЗ]ред ржЖрж╕рж╛ржорзА [ржЖрж╕рж╛ржорзАрж░ ржирж╛ржо] ржмрж╛ржжрзАрж░ рж╕рж╛ржерзЗ [ржкрзНрж░рждрж╛рж░ржгрж╛/ржорж╛рж░рж╛ржорж╛рж░рж┐/ржШржЯржирж╛] ржХрж░рж┐рзЯрж╛ржЫрзЗред ржЖржорж┐ ржПржЗ ржШржЯржирж╛рж░ рж╕рзБрж╖рзНржарзБ ржмрж┐ржЪрж╛рж░ ржЪрж╛ржЗред"
      </p>
      <p>&nbsp;</p>

      <p>ржЗрж╣рж╛ ржЖржорж╛рж░ ржЬржмрж╛ржиржмржирзНржжрж┐, ржЖржорж╛ржХрзЗ ржкрзЬрж┐рзЯрж╛ рж╢рзБржирж╛ржЗрж▓рзЗ ржЖржорж┐ рж╢рзБржжрзНржз ржорж░рзНржорзЗ рж╕рзНржмрзАржХрж╛рж░ ржХрж░рж┐рзЯрж╛ рж╕рж╣рж┐ рж╕ржорзНржкрж╛ржжржи ржХрж░рж▓рж╛ржоред</p>
      <p>&nbsp;</p>
      <p>&nbsp;</p>

      <p>_________________________</p>
      <p><b>рж╕рж╛ржХрзНрж╖рзАрж░ рж╕рзНржмрж╛ржХрзНрж╖рж░/ржЯрж┐ржкрж╕рж╣рж┐</b></p>
      <p>рждрж╛рж░рж┐ржЦ: [рж░рж┐ржкрзЛрж░рзНржЯрзЗ ржЙрж▓рзНрж▓рж┐ржЦрж┐ржд рждржжржирзНрждрзЗрж░ рждрж╛рж░рж┐ржЦ]</p>

      <br style="page-break-after: always;">


      <p><b>рззрзмрзз ржзрж╛рж░рж╛рзЯ ржЬржмрж╛ржиржмржирзНржжрж┐ - рж╕рж╛ржХрзНрж╖рзА ржиржВ рзи</b></p>
      <p>&nbsp;</p>
      <p><b>ржирж╛ржо:</b> [ржирж╛ржо]</p>
      ... (ржмрж╛ржХрж┐ рждржерзНржп ржПржХржЗ ржлрж░ржорзНржпрж╛ржЯрзЗ)

      <br style="page-break-after: always;">
    `;

    const result = await model.generateContent(prompt);
    
    // ржХрзНрж▓рж┐ржиржЖржк
    let statementText = result.response.text().replace(/```html/g, "").replace(/```/g, "");

    return NextResponse.json({ statement: statementText });

  } catch (error) {
    console.error("Error:", error);
    return NextResponse.json({ error: "рж╕рж╛рж░рзНржнрж╛рж░рзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗред" }, { status: 500 });
  }
}